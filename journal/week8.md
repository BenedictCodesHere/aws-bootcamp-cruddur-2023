# Week 8 â€” Serverless Image Processing

## Aim
The aim this week was being able to upload avatars, render them correctly and return the correctly resized versions for use as the profile picture of the user.
The tech stack used is:
- AWS CDK (Typescript)
- Amazon S3
- AWS Lambda
- Amazon SNS
- AWS IAM
- Amazon CloudFront

AWS CDK is listed first as this is the method by which we are implementing the desired outcomes in the other Amazon services.

CDK is a Cloud Development Kit, which is a way of utilising the desired coding language (Typescript) to define and create instances of 
other services within AWS.

## Serverless Image Process CDK
IN "./":
Created a thumbing-serverless-cdk directory. This is where the CDK files are stored.

IN "./thumbing-serverless-cdk/lib/thumbing-serverless-cdk-stack.ts":
    Defined and created instances of:
- CDK Stack
- lambda function
- topic and subscription
- s3 event notifications
- Bucket access policies

Also attached policies to roles.


## Serving Avatars Via CloudFront
We want to create a CloudFront distribution in order to serve the avatar assets in the quickest and most available manner.
In the AWS UI:
- Chose the origin domain
- Origin access control settings (restrict bucket access to only CloudFront)
- Update S3 Bucket Policy (policy generated by CloudFront, CloudFront doesn't auto-attach policy to the bucket)
- Create Cache Policy
- Create an SSL certificate using ACM

Adding CDK in the folder ./thumbing-serverless-cdk

import s3 object from aws-cdk-lib

define bucket(scope, id, props)

cdk synth

cdk bootstrap - bootstraps for account, region

## Lambda source code

### Prior to CDK Deploy:
Run 'npm install' in the 'process-images' directory
- Otherwise lambda function will hit errors due to missing modules


ERRORS - bucket name incorrect

The original bucket was being published under "cruddur-thumbs" in the example. After changing bucket name and redeploying, the bucket name remained "cruddur-thumbs". The stack itself had to be torn down in order to rename the bucket.

Then it was discovered that it was environment variables (used grep to check) that were causing this issue.

Environment variable chain/hierarchy is always important to understand and check.

On CDK Deploy:

The lambda function and the bucket are created, and alongside them, IAM service roles are created.



## CLOUDFRONT

- ACM for CloudFront must be hosted in us-east-1

- Set up Route 53 - alias to assets.cruddurclone.com

- Adding the bucket policy from CloudFront to attach to the S3 bucket


## Architecture - S3
- Separating the bucket into assets bucket and processed bucket
    - Advantage of being able to lock down the originals bucket and separate so only processed is publicly served
